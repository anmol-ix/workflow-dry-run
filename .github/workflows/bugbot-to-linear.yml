name: BugBot -> Linear comment

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Post BugBot comment to Linear
        uses: actions/github-script@v7
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        with:
          script: |
            const linearKey = process.env.LINEAR_API_KEY;
            if (!linearKey) core.setFailed("Missing LINEAR_API_KEY secret");

            // --- Detect event type + extract comment payload ---
            let comment, prNumber, repo;
            repo = context.repo;

            const isIssueComment = context.eventName === "issue_comment";
            const isReviewComment = context.eventName === "pull_request_review_comment";

            if (isIssueComment) {
              // issue_comment fires for issues and PRs; only proceed if it's a PR.  [oai_citation:4â€¡GitHub Docs](https://docs.github.com/actions/learn-github-actions/events-that-trigger-workflows?utm_source=chatgpt.com)
              if (!context.payload.issue.pull_request) return;
              comment = context.payload.comment;
              prNumber = context.payload.issue.number;
            } else if (isReviewComment) {
              comment = context.payload.comment;
              prNumber = context.payload.pull_request.number;
            } else {
              return;
            }

            const authorLogin = (comment.user && comment.user.login) ? comment.user.login.toLowerCase() : "";
            const body = comment.body || "";

            // --- BugBot detection ---
            const looksLikeBugBot =
              authorLogin === "cursor" ||
              body.includes("<!-- CURSOR_SUMMARY -->") ||
              body.toLowerCase().includes("bugbot") ||
              body.toLowerCase().includes("cursor");

            if (!looksLikeBugBot) return;

            // --- Fetch PR details (for branch + title + URL) ---
            const prResp = await github.rest.pulls.get({
              owner: repo.owner,
              repo: repo.repo,
              pull_number: prNumber,
            });

            const pr = prResp.data;
            const prUrl = pr.html_url;
            const headRef = pr.head.ref || "";
            const prTitle = pr.title || "";

            // --- Extract Linear issue key (e.g., INN-20) from branch or title ---
            const keyRegex = /[A-Z]{2,10}-\d{1,6}/;
            const match = headRef.match(keyRegex) || prTitle.match(keyRegex);
            if (!match) {
              core.info(`No Linear issue key found in branch/title for PR #${prNumber}`);
              return;
            }
            const issueKey = match[0];

            // --- Linear GraphQL helpers ---
            async function linearGraphQL(query, variables) {
              const res = await fetch("https://api.linear.app/graphql", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": linearKey, // Personal API key auth  [oai_citation:5â€¡Linear](https://linear.app/developers/graphql)
                },
                body: JSON.stringify({ query, variables }),
              });
              const json = await res.json();
              if (json.errors) {
                throw new Error(JSON.stringify(json.errors));
              }
              return json.data;
            }

            // --- Find Linear issue by identifier (INN-20) ---
            const findIssueQuery = `
              query FindIssue($identifier: String!) {
                issues(filter: { identifier: { eq: $identifier } }) {
                  nodes { id identifier title }
                }
              }
            `;
            const data = await linearGraphQL(findIssueQuery, { identifier: issueKey });
            const issue = data.issues.nodes[0];
            if (!issue) {
              core.info(`Linear issue not found for identifier: ${issueKey}`);
              return;
            }

            // --- Compose Linear comment body ---
            const ghCommentUrl = comment.html_url || prUrl;
            const prefix = isReviewComment
              ? `ðŸ¤– BugBot review comment captured from PR #${prNumber}`
              : `ðŸ¤– BugBot PR comment captured from PR #${prNumber}`;

            const linearBody =
              `${prefix}\n` +
              `PR: ${prUrl}\n` +
              `GitHub Comment: ${ghCommentUrl}\n\n` +
              body;

            // --- Create Linear comment ---
            const commentCreateMutation = `
              mutation AddComment($issueId: String!, $body: String!) {
                commentCreate(input: { issueId: $issueId, body: $body }) {
                  success
                  comment { id }
                }
              }
            `;
            await linearGraphQL(commentCreateMutation, { issueId: issue.id, body: linearBody });

            core.info(`Posted BugBot feedback to Linear: ${issue.identifier} - ${issue.title}`);
